<!doctype html><html lang=en-us><head><title>watch-diff: Watch command output and get notified on changes | berfr blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://berfr.me/posts/watch-diff/><link rel=stylesheet href=/css/styles.min.css></head><body><header><h2><a href=/>berfr blog</a></h2></header><hr><article class=post><header><h1>watch-diff: Watch command output and get notified on changes</h1><div class=post-time>Posted on March 01, 2020.</div></header><p>For a few months now, I have been using my
<a href=https://github.com/berfr/watch-diff><code>watch-diff</code></a> project to get notified on
command output changes. The beauty of this simple tool is that it works with any
command that can be executed in the shell. This means that once you figure out
the exact command you need to monitor, you simply plug it into <code>watch-diff</code> and
you automatically get email notifications on updates.</p><h2 id=example-monitoring-current-releases>Example: monitoring current releases</h2><p>Here is the output for monitoring the current version of this package on the
PyPI website while a release is being made:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff>$ watch-diff &#34;curl -s https://pypi.org/project/watch-diff/ | \
    sed -n &#39;/&lt;h1 class=\&#34;package-header__name\&#34;&gt;/,/&lt;\/h1&gt;/p&#39;&#34;
[2020-03-01 01:04:11.697054] first_run:
      &lt;h1 class=&#34;package-header__name&#34;&gt;
        watch-diff 1.0.2
      &lt;/h1&gt;
[2020-03-01 01:04:16.839766] no diff
[2020-03-01 01:04:21.986465] no diff
[2020-03-01 01:04:27.122121] no diff
[2020-03-01 01:04:32.278194] no diff
[2020-03-01 01:04:37.424123] diff:
<span class=gd>--- Previous    2020-03-01 01:04:32.278194
</span><span class=gd></span><span class=gi>+++ Current     2020-03-01 01:04:37.424123
</span><span class=gi></span><span class=gu>@@ -1,3 +1,3 @@
</span><span class=gu></span>       &lt;h1 class=&#34;package-header__name&#34;&gt;
<span class=gd>-        watch-diff 1.0.2
</span><span class=gd></span><span class=gi>+        watch-diff 1.0.3
</span><span class=gi></span>       &lt;/h1&gt;
[2020-03-01 01:04:42.710685] no diff
...
</code></pre></div><h2 id=no-extra-dependencies>No extra dependencies</h2><p>This Python package does not require any extra PyPI packages to function.
Instead, it relies on a few packages from the Standard Library. These include:</p><ul><li><a href=https://docs.python.org/3/library/argparse.html><code>argparse</code></a>: Handle arguments passed to the CLI command.</li><li><a href=https://docs.python.org/3/library/datetime.html><code>datetime</code></a>: Manage timestamps for command runs.</li><li><a href=https://docs.python.org/3/library/difflib.html><code>difflib</code></a>: Get nice looking diffs of command outputs.</li><li><a href=https://docs.python.org/3/library/email.html><code>email</code></a>: Used to add multiple parts and message IDs to email.</li><li><a href=https://docs.python.org/3/library/smtplib.html><code>smtplib</code></a>: Communication with SMTP server.</li><li><a href=https://docs.python.org/3/library/subprocess.html><code>subprocess</code></a>: Calling the actual command and reading the output.</li></ul><p>Since there aren&rsquo;t any additional packages installed with <code>watch-diff</code>, there
isn&rsquo;t much danger in installing it globally with <code>pip</code> as a regular user. This
has the advantage of being able to call it from wherever without having to worry
about a virtual environment.</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># install as user in home directory</span>
pip install --user watch-diff
</code></pre></div><h2 id=email-thread-handling>Email thread handling</h2><p>By setting the <code>Message-ID</code> and <code>In-Reply-To</code> in the emails sent, they are
easily grouped together in their respective runs. This makes it possible to
start multiple instances of <code>watch-diff</code> all watching different commands while
keeping a tidy inbox.</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>Mar 01 2020 watch-diff (2.8K)   ┌─&gt;
Mar 01 2020 watch-diff (2.9K) ┌─&gt;watch-diff diff: ls -la
Mar 01 2020 watch-diff (7.5K) watch-diff first_run: ls -la
Mar 01 2020 watch-diff (1.6K)                   ┌─&gt;
Mar 01 2020 watch-diff (1.6K)                 ┌─&gt;
Mar 01 2020 watch-diff (1.6K)               ┌─&gt;
Mar 01 2020 watch-diff (1.6K)             ┌─&gt;
Mar 01 2020 watch-diff (1.6K)           ┌─&gt;
Mar 01 2020 watch-diff (1.6K)         ┌─&gt;
Mar 01 2020 watch-diff (1.6K)       ┌─&gt;
Mar 01 2020 watch-diff (1.6K)     ┌─&gt;
Mar 01 2020 watch-diff (1.6K)   ┌─&gt;
Mar 01 2020 watch-diff (1.6K) ┌─&gt;watch-diff diff: date
Mar 01 2020 watch-diff (1.3K) watch-diff first_run: date
</code></pre></div><h2 id=configuration>Configuration</h2><p>Configuration of <code>watch-diff</code> is only needed if the <code>-r/--recipient</code> option is
used. This triggers email notifications and so SMTP settings are needed. If
used, the program will either prompt the user for the needed values or use the
ones set in environment variables if available. The following variables are
used:</p><ul><li><code>SMTP_HOST</code></li><li><code>SMTP_PORT</code></li><li><code>SMTP_USER</code></li><li><code>SMTP_PASS</code></li></ul><p>These can be exported in the <code>~/.bashrc</code> file so they are available at any time.</p><p>A good strategy for more secure configuration is to create an email account that
is used exclusively for sending emails. If the credentials get compromised, it
is has less impact than if your main email credentials get stolen. Also, it is a
good idea to use <code>secret-tool lookup ...</code> to get the SMTP password so that it is
not written in plain text in a config file.</p><h2 id=further-work>Further work</h2><p>I am very satisfied with this tool right now; it is super simple to use with
whatever shell command, the emails are tidy and they look good. If you have any
issues or want to suggest or contribute a feature, feel free to contact me!</p></article><hr><footer><p><a href=https://github.com/berfr>GitHub</a> /
<a href=https://git.sr.ht/~berfr>SourceHut</a></p><p><a href=/publickey.txt>67CA4E4F727349D3</a></p><p><a href=mailto:berfr4@gmail.com>berfr4@gmail.com</a></p><p><a href=/index.xml>RSS</a></p></footer></body></html>